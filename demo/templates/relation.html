{% extends "base.html" %} {% block mainbody %}
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title></title>
    <meta charset="utf-8" />
    <script src="/static/js/echarts.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-gl@2/dist/echarts-gl.min.js"></script>
{#    <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/echarts-all-3.js"></script>#}
<style>
        .chart-container {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 600px;
            background: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            border-radius: 8px;
        }
        .chart-container .close-btn {
            text-align: right;
        }
        .chart-container .close-btn button {
            background: #ff4d4f;
            color: #fff;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 4px;
        }
        .chart-container .close-btn button:hover {
            background: #d9363e;
        }
</style>
</head>
<title>å…³ç³»</title>
<div class="container">
    <div class="row">
    <!--head start-->
    <div class="col-md-12">
        <h3 class="page-header"><i class="fa fa-link" aria-hidden="true"></i> åˆ†ææ—¥å¿— </h3>
            <ol class="breadcrumb">
                <li><i class="fa fa-home"></i><a href="\">Home</a></li>
                <li><i class="fa fa-link" aria-hidden="true"></i>åˆ†ææ—¥å¿—</li>
            </ol>
    </div>
    
    <div class = "col-md-12">
    	<div class = "panel panel-default">

       		<div class = "panel-body">

			    <form  id ="searchRelationForm" class="form-inline" style="padding-left: 2% ; padding-right: 0%" method="get">
					<label>æ‰§è¡Œæè¿°</label>
			    	<div id = "entity1" class="form-group" style="padding-left: 2%">
			        	<input type="text" id = "entity1_text" name = "entity1_text" class ="form-control" placeholder="è¯·è¾“å…¥æ‰§è¡Œæè¿°" aria-describedby="basic-addon1">
			 		</div>
			 		<!--dropdown combobox start-->
					<label style="padding-left: 2%;">æ‰§è¡Œç®—æ³•</label>
			        <div class="btn-group" style="padding-left: 2%" > <a class="btn btn-default dropdown-toggle btn-select form-control" data-toggle="dropdown" id="btnCountry">Select a Algorithm<span class="caret"></span></a>
			            <ul class="dropdown-menu">
			                <li onclick="selectOption(1)"><a href="#">PCA</a></li>
			                <li onclick="selectOption(2)"><a href="#">clustering</a></li>
			                <li onclick="selectOption(3)"><a href="#">Decision Tree</a></li>
			                <li onclick="selectOption(4)"><a href="#">Random Forest</a></li>
			                <li onclick="selectOption(5)"><a href="#">SVM</a></li>
			                <li onclick="selectOption(6)"><a href="#">Transformer</a></li>
			                <li onclick="selectOption(7)"><a href="#">BERT</a></li>
			                <li onclick="selectOption(8)"><a href="#">LSTM</a></li>
			                <li class="divider"></li>
			                <li><a href="#"><span class="glyphicon glyphicon-star"></span>Other</a></li>
			            </ul>
			        </div>
			        <!--dropdown combobox end-->
			        <div id = "relation_name" class = "form-group hide" style="padding-top: 2%">
			        	 <input type="text" id = "relation_name_input" name = "relation_name_text" class ="form-control" placeholder="è¾“å…¥å…³ç³»åç§°" aria-describedby="basic-addon1">
			        </div>
					<label style="padding-left: 2%;">æ‰§è¡Œç”¨æˆ·</label>
			        <div id = "entity2" class = "form-group" style="padding-top: 0%">
			        	 <input type="text" id = "entity2_text" name = "entity2_text" class ="form-control" placeholder="è¯·è¾“å…¥æ‰§è¡Œç”¨æˆ·" aria-describedby="basic-addon1">
			        </div>
			        <div class="btn-group" style="padding-top: 0%; padding-left: 1%;">
			            <button type="button" id="btnSearch" class="btn btn-primary" onclick = "document.getElementById('searchRelationForm').submit();">Search</button>
			        </div>
				</form>
			</div>
		</div>
	</div>


    <div class = "col-md-12">
		<div class="panel panel-default">
			<header class="panel-heading">
				æŸ¥è¯¢æ¡ä»¶ï¼š


    <button class="execute-command">âš¡ æ‰§è¡Œå‘½ä»¤</button>
    <button class="clear-command">âœ– æ¸…ç©º</button>
    <button class="delete-command">ğŸ—‘ åˆ é™¤</button>

	<script>
 
 		let selectedOption = 0;
        let chart = null;

		function selectOption(option) {
			selectedOption = option;
			document.getElementById('startexe').innerText = `å¼€å§‹æ‰§è¡Œ`;
            var algorithmNames = ["PCA", "Clustering", "Decision Tree", "Random Forest", "SVM", "Transformer", "BERT", "LSTM"];
            document.getElementById('btnCountry').innerText = algorithmNames[option - 1] + ' ';
		}

		function randomClusterCenter() {
            return {
                x: Math.random() * 100 - 50,
                y: Math.random() * 100 - 50,
                z: Math.random() * 100 - 50
            };
        }

        function generateClusterPoints(center, numPoints, spread) {
            const points = [];
            for (let i = 0; i < numPoints; i++) {
                const point = [
                    center.x + (Math.random() - 0.5) * spread,
                    center.y + (Math.random() - 0.5) * spread,
                    center.z + (Math.random() - 0.5) * spread
                ];
                points.push(point);
            }
            return points;
        }

        function generateNoisePoints(numPoints) {
            const points = [];
            for (let i = 0; i < numPoints; i++) {
                const point = [
                    Math.random() * 100 - 50,
                    Math.random() * 100 - 50,
                    Math.random() * 100 - 50
                ];
                points.push(point);
            }
            return points;
        }

        // ç”Ÿæˆèšç±»æ•°æ®
        function generateClusterData(numClusters, pointsPerCluster, clusterSpread, noiseLevel) {
            data = [];
            outliers = [];

            for (let i = 0; i < numClusters; i++) {
                const center = randomClusterCenter();
                const clusterPoints = generateClusterPoints(center, pointsPerCluster, clusterSpread);
                data.push(...clusterPoints);
            }

            const noisePoints = generateNoisePoints(pointsPerCluster * numClusters * noiseLevel);
            data.push(...noisePoints);

            // ç”Ÿæˆç¦»ç¾¤ç‚¹
            const numOutliers = 3; // è®¾å®šç¦»ç¾¤ç‚¹æ•°é‡
            for (let i = 0; i < numOutliers; i++) {
                const outlier = [
                    Math.random() * 200 - 100,
                    Math.random() * 200 - 100,
                    Math.random() * 200 - 100
                ];
                outliers.push(outlier);
            }

            return { data, outliers };
        }

        function selectOption(option) {
            selectedOption = option;
            document.getElementById('startexe').innerText = `å¼€å§‹æ‰§è¡Œ`;
            var algorithmNames = ["PCA", "Clustering", "Decision Tree", "Random Forest", "SVM", "Transformer", "BERT", "LSTM"];
            document.getElementById('btnCountry').innerText = algorithmNames[option - 1] + ' ';
    
        }

        function randomClusterCenter() {
            return {
                x: Math.random() * 100 - 50,
                y: Math.random() * 100 - 50,
                z: Math.random() * 100 - 50
            };
        }

        function generateClusterPoints(center, numPoints, spread) {
            const points = [];
            for (let i = 0; i < numPoints; i++) {
                const point = [
                    center.x + (Math.random() - 0.5) * spread,
                    center.y + (Math.random() - 0.5) * spread,
                    center.z + (Math.random() - 0.5) * spread
                ];
                points.push(point);
            }
            return points;
        }

        function generateNoisePoints(numPoints) {
            const points = [];
            for (let i = 0; i < numPoints; i++) {
                const point = [
                    Math.random() * 100 - 50,
                    Math.random() * 100 - 50,
                    Math.random() * 100 - 50
                ];
                points.push(point);
            }
            return points;
        }

        // ç”Ÿæˆèšç±»æ•°æ®
        function generateClusterData(numClusters, pointsPerCluster, clusterSpread, noiseLevel) {
            const data = [];
            const outliers = [];

            for (let i = 0; i < numClusters; i++) {
                const center = randomClusterCenter();
                const clusterPoints = generateClusterPoints(center, pointsPerCluster, clusterSpread);
                data.push(...clusterPoints);
            }

            const noisePoints = generateNoisePoints(pointsPerCluster * numClusters * noiseLevel);
            data.push(...noisePoints);

            // ç”Ÿæˆç¦»ç¾¤ç‚¹
            const numOutliers = 3; // è®¾å®šç¦»ç¾¤ç‚¹æ•°é‡
            for (let i = 0; i < numOutliers; i++) {
                const outlier = [
                    Math.random() * 200 - 100,
                    Math.random() * 200 - 100,
                    Math.random() * 200 - 100
                ];
                outliers.push(outlier);
            }

            return { data, outliers };
        }

        function showGraph(fileid) {
            const url = '/api/data_analysis/';
            const test_data = {
                option: selectedOption,
                fileid: fileid,
            };
            console.log('Success:')
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(test_data)
            })
            .then(response => response.json())
            .then(test_data => {
                console.log('Success:', test_data);
            })
            .catch((error) => {
                console.error('Error:', error);
            });
            // const timeDisplay = document.getElementById('time_show');
            // // è·å–å½“å‰æ—¶é—´
            // const currentTime = new Date().toLocaleString();
            // // å°†æ—¶é—´æ˜¾ç¤ºåœ¨æŒ‡å®šå…ƒç´ ä¸­
            // timeDisplay.textContent = currentTime;

            // ä¿®æ”¹æŒ‰é’®æ–‡æœ¬
            document.getElementById('startexe').innerText = `å†æ¬¡æ‰§è¡Œ (é€‰é¡¹ ${selectedOption})`;

            // æ˜¾ç¤ºå›¾è¡¨å®¹å™¨
            const chartContainer = document.getElementById('chartContainer');
            chartContainer.style.display = 'block';

            // é”€æ¯ä¹‹å‰çš„å›¾è¡¨å®ä¾‹
            if (chart !== null) {
                chart.dispose();
            }

            // åˆå§‹åŒ–EChartså®ä¾‹
            chart = echarts.init(document.getElementById('chart'));

            if (selectedOption === 1) {
                // ç”Ÿæˆæ­£æ€åˆ†å¸ƒéšæœºæ•°
                function randomNormal(mean, std) {
                    var u = 0, v = 0;
                    while (u === 0) u = Math.random();
                    while (v === 0) v = Math.random();
                    return mean + std * Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
                }

                // ç”Ÿæˆéšæœºæ•£ç‚¹æ•°æ®
                var a = 20; // å¸¸æ•°a
                var data = [];
                for (var i = 0; i < 200; i++) {
                    var x = randomNormal(a / 2, a / 6); // æ­£æ€åˆ†å¸ƒéšæœºç”Ÿæˆx
                    x = Math.max(0, Math.min(a, x)); // ç¡®ä¿xåœ¨[0, a]èŒƒå›´å†…
                    var y = a - x + randomNormal(0, a / 10); // å¢åŠ éšæœºæ€§
                    y = Math.max(0, y); // ç¡®ä¿yåœ¨ç¬¬ä¸€è±¡é™
                    data.push([x, y]);
                }

                // ç¡®å®šç¦»ç¾¤ç‚¹ï¼ˆè¿™é‡Œç®€å•å¤„ç†ï¼šè¶…è¿‡ä¸€å®šèŒƒå›´çš„ç‚¹ä¸ºç¦»ç¾¤ç‚¹ï¼‰
                var outliers = data.filter(point => point[0] < 2 || point[0] > a - 2 || point[1] < 2 || point[1] > a - 2);
                var inliers = data.filter(point => !outliers.includes(point));

                // æŒ‡å®šå›¾è¡¨çš„é…ç½®é¡¹å’Œæ•°æ®
                var option = {
                    title: {
                        text: 'Scatter Plot on y = a - x Line',
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'item'
                    },
                    xAxis: {
                        type: 'value'
                    },
                    yAxis: {
                        type: 'value'
                    },
                    series: [
                        {
                            name: 'Inliers',
                            type: 'scatter',
                            data: inliers,
                            itemStyle: {
                                color: 'green'
                            }
                        },

                    ]
                };

                // ä½¿ç”¨åˆšæŒ‡å®šçš„é…ç½®é¡¹å’Œæ•°æ®æ˜¾ç¤ºå›¾è¡¨
                chart.setOption(option);
            } else if (selectedOption === 2) {
                // ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
                const numClusters = 1;
                const pointsPerCluster = 40;
                const clusterSpread = 2;
                const noiseLevel = 0.7;
                const { data, outliers } = generateClusterData(numClusters, pointsPerCluster, clusterSpread, noiseLevel);

                // æŒ‡å®šå›¾è¡¨çš„é…ç½®é¡¹å’Œæ•°æ®
                var option = {
                    title: {
                        text: 'Test Data - t-SNE'
                    },
                    xAxis3D: {
                        type: 'value'
                    },
                    yAxis3D: {
                        type: 'value'
                    },
                    zAxis3D: {
                        type: 'value'
                    },
                    grid3D: {
                        viewControl: {
                            // 3Dè§†å›¾æ§åˆ¶
                            projection: 'orthographic'
                        }
                    },
                    series: [
                        {
                            type: 'scatter3D',
                            data: data,
                            symbolSize: 10,
                            itemStyle: {
                                opacity: 0.8
                            }
                        },
                        {
                            type: 'scatter3D',
                            data: outliers,
                            symbolSize: 10,
                            itemStyle: {
                                color: 'red',
                                opacity: 0.8
                            }
                        }
                    ]
                };

                // ä½¿ç”¨åˆšæŒ‡å®šçš„é…ç½®é¡¹å’Œæ•°æ®æ˜¾ç¤ºå›¾è¡¨
                chart.setOption(option);
            }
        }

        function closeChart() {
            document.getElementById('chartContainer').style.display = 'none';
        }
	</script>
    <!-- <table>
        <thead>
            <tr>
                <th><input type="checkbox"></th>
                <th>id</th>
                <th>æ‰§è¡Œæè¿°</th>
                <th>æ‰§è¡Œå‘½ä»¤</th>
                <th>æ‰§è¡Œç”¨æˆ·</th>
                <th>æ‰§è¡ŒçŠ¶æ€</th>
                <th>æ‰§è¡Œæ—¶é—´</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><input type="checkbox"></td>
                <td>1160<br>4</td>
                <td>ps -ef | grep "java"</td>
                <td>ps -ef | grep "java"</td>
                <td>admin</td>
                <td><span class="status-completed">ä¸Šä¼ å®Œæˆ</span></td>
                <td id="time_show">2024-06-01 16:39:50<br>æŒç»­æ—¶é—´: 10s</td>
                <td>
                    <button  class="action-link" id="startexe" onclick="showGraph()">å¼€å§‹æ‰§è¡Œ</button>
                    <a href="#" class="action-link">å‘½ä»¤</a>
                    <a href="#" class="action-link">æ—¥å¿—</a>
                    <a href="#" class="action-link">ä¸­æ–­</a>
                    <a href="#" class="action-link delete">åˆ é™¤</a>
                </td>
            </tr>
        </tbody>
    </table> -->
    <table>
        <thead>
            <tr>
                <th><input type="checkbox"></th>
                <th>id</th>
                <!-- <th>æ‰§è¡Œæè¿°</th> -->
                <!-- <th>æ‰§è¡Œå‘½ä»¤</th> -->
                <th>æ–‡ä»¶å‘½å</th>
                <th>æ‰§è¡Œç”¨æˆ·</th>
                <th>æ‰§è¡ŒçŠ¶æ€</th>
                <th>ä¸Šä¼ æ—¶é—´</th>
                <th>æ–‡ä»¶å¤§å°</th>
                <th>æ–‡ä»¶æè¿°</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% for row in rows %}
            <tr>
                <td><input type="checkbox"></td>
                <td>{{ row.id }}</td>
                <!-- <td>{{ row.description }}</td> -->
                <td>{{row.filename}}</td>
                <td>admin</td>
                <td><span class="status-completed">ä¸Šä¼ å®Œæˆ</span></td>
                <td>{{ row.upload_date }}</td>
                <td>{{ row.file_size }} KB</td>
                <td>{{row.file_description}}</td>
                <td>
                    <button class="action-link" id="startexe" onclick="showGraph('{{ row.id }}')">å¼€å§‹æ‰§è¡Œ</button>
                    <a href="#" class="action-link">å‘½ä»¤</a>
                    <a href="#" class="action-link">æ—¥å¿—</a>
                    <a href="#" class="action-link">ä¸­æ–­</a>
                    <a href="#" class="action-link delete">åˆ é™¤</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
	<div class="chart-container" id="chartContainer">
        <div class="close-btn">
            <button onclick="closeChart()">å…³é—­</button>
        </div>
        <div id="chart" style="width: 100%; height: 400px;"></div>
    </div>
	</div>
	
	<!-- {% if ctx %}
	<div class = "col-md-12">
		<div class = "panel panel-default">
			<header class = "panel-heading">
				æŸ¥è¯¢ç»“æœï¼š
			</header>
			<div class = "panel-body">
				<div style="padding: 2%">
					<h2>æš‚æœªæ‰¾åˆ°ç›¸åº”çš„åŒ¹é…</h2>
				</div>
			</div>
		</div>
	</div>
	{% endif %} -->

    

</div>
<!-- <script src="/static/js/jquery-1.8.3.min.js"></script>
{% if searchResult %}
<script type="text/javascript">
	var searchResult = {{searchResult|safe}}
	//ç”¨è¡¨æ ¼åˆ—å‡ºæ‰€æœ‰çš„å…³ç³»
    tableData = []
    for (var i = 0 ; i < searchResult.length ; i++){
        relationData = {} ;
        relationData['entity1'] = searchResult[i]['n1']['title'];
        relationData['relation'] = searchResult[i]['rel']['type'] ;
        relationData['entity2'] = searchResult[i]['n2']['title'] ;
        tableData.push(relationData) ;
    }
    jQuery(function(){
        $('.table').footable({
        "columns": [{"name":"entity1",title:"Entity1"} ,
                  {"name":"relation",title:"Relation"},
                  {"name":"entity2",title:"Entity2"}],
        "rows": tableData
        });
    });

    //echarts æ•°æ®
    var data = [] ;
    var links = [] ;	

    //æ„é€ å±•ç¤ºçš„æ•°æ®
    var maxDisPlayNode = 15 ;
    var id = 0 ;
    for( var i = 0 ;id < maxDisPlayNode&& i<searchResult.length ; i++ ){
        //è·å–node1
        node1 = {} ;
        node1['name'] = searchResult[i]['n1']['title'] ;
        node1['draggable'] = true ;
        if('url' in searchResult[i]['n1']){
            node1['category'] = 1 ;
        }
        else{
            node1['category'] = 2 ;
        }
        var flag = 1 ;

        relationTarget = id.toString() ;
        for(var j = 0 ; j<data.length ;j++){
        	if(data[j]['name'] === node1['name']){
        		flag = 0 ;
        		relationTarget = data[j]['id'] ;
        		break ;
        	}
        }

        node1['id'] = relationTarget ; 
        if(flag === 1){
        	id++ ;
        	data.push(node1) ;
        }

        //è·å–node2
        node2 = {} ;
        node2['name'] = searchResult[i]['n2']['title'] ;
        node2['draggable'] = true ;
        if('url' in searchResult[i]['n2']){
            node2['category'] = 1 ;
        }
        else{
            node2['category'] = 2 ;
        }
        flag = 1 ;
        relationTarget = id.toString() ;
        for(var j = 0 ; j<data.length ;j++){
        	if(data[j]['name'] === node2['name']){
        		flag = 0 ;
        		relationTarget = data[j]['id'] ;
        		break ;
        	}
        }
        node2['id'] = relationTarget ; 
        if(flag === 1){
        	id++ ;
        	data.push(node2) ;
        }
        //è·å–relation
        relation = {}
        relation['source'] = node1['id'];
        relation['target'] = node2['id'] ;
        relation['category'] = 0 ;
        flag = 1;  
        for(var j = 0 ;j<links.length;j++){
        	if(links[j]['source'] == relation['source'] && links[j]['target'] == relation['target']){
        		links[j]['value'] = links[j]['value'] + searchResult[i]['rel']['type'] ;
        		flag = 0 ;
        		break ;
        	}
        }           
        if(flag === 1){
        	relation['value'] = searchResult[i]['rel']['type'] ;
        	relation['symbolSize'] = 10;
        	links.push(relation) ;
        }

    }


     // åŸºäºå‡†å¤‡å¥½çš„domï¼Œåˆå§‹åŒ–echartså®ä¾‹
    var myChart = echarts.init(document.getElementById('graph'));
    
    option = {
	    title: {
	        text: ''
	    },
	    tooltip: {},
	    animationDurationUpdate: 1500,
	    animationEasingUpdate: 'quinticInOut',
	    label: {
	        normal: {
	            show: true,
	            textStyle: {
	                fontSize: 12
	            },
	        }
	    },
	    legend: {
	        x: "center",
	        show: false
	    },
	    series: [

	        {
	            type: 'graph',
	            layout: 'force',
	            symbolSize: 45,
	            focusNodeAdjacency: true,
	            roam: true,
	            edgeSymbol: ['none', 'arrow'],
	            categories: [{
	                name: 'æŸ¥è¯¢å®ä½“',
	                itemStyle: {
	                    normal: {
	                        color: "#009800",
	                    }
	                }
	            }, {
	                name: 'HudongItem',
	                itemStyle: {
	                    normal: {
	                        color: "#4592FF",
	                    }
	                }
	            }, {
	                name: 'NewNode',
	                itemStyle: {
	                    normal: {
	                        color: "#C71585",
	                    }
	                }
	            }],
	            label: {
	                normal: {
	                    show: true,
	                    textStyle: {
	                        fontSize: 12,
	                    },
	                }
	            },
	            force: {
	                repulsion: 1000
	            },
	            edgeSymbolSize: [4, 50],
	            edgeLabel: {
	                normal: {
	                    show: true,
	                    textStyle: {
	                        fontSize: 10
	                    },
	                    formatter: "{c}"
	                }
	            },
	            data: data,
	            links: links,
	            lineStyle: {
	                normal: {
	                    opacity: 0.9,
	                    width: 1.3,
	                    curveness: 0,
	                    color:"#262626",
	                }
	            }
	        }
	    ]
	};
	// ä½¿ç”¨åˆšæŒ‡å®šçš„é…ç½®é¡¹å’Œæ•°æ®æ˜¾ç¤ºå›¾è¡¨ã€‚
	myChart.setOption(option);

</script>

{% endif %} -->
<!-- <script>

	$(".dropdown-menu li a").click(function(){
	   var selText = $(this).text();
	   $(this).parents('.btn-group').find('.dropdown-toggle').html(selText+' <span class="caret"></span>');
	   if(selText.trim()!="Other"){
	   	$("#relation_name_input").val(selText.trim()) ;
	   }
	   //combobox behavior
	   if (selText.trim()==="Other") {
	       $("#relation_name").removeClass("hide");
	   }
	   else{
	   	   $("#relation_name").addClass("hide");
	   }
	  
	});


	// $("#btnSearch").click(function(){
	// 	alert($('.btn-select').text()+", "+$('.btn-select2').text());
	// });
</script> -->
{% endblock %}
